AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Tappy Backend (Orders & Payments + API)
Parameters:
  JwtSecret:
    Type: String
    Description: JWT secret for auth tokens
    NoEcho: true
  DeployTag:
    Type: String
    Description: Small tag or git SHA for traceability
    Default: dev
  KhipuApiKey:
    Type: String
    Description: Khipu API Key for API 3.0
    NoEcho: true
    Default: ''
  PublicSuccessUrl:
    Type: String
    Description: Public success URL (frontend)
    Default: https://tappy.cl/checkout/success
  PublicCancelUrl:
    Type: String
    Description: Public cancel URL (frontend)
    Default: https://tappy.cl/checkout/cancel
  PublicBaseApi:
    Type: String
    Description: Public API base (for webhooks)
    Default: https://api.tappy.cl
Globals:
  Function:
    Runtime: nodejs18.x
    Timeout: 15
    MemorySize: 512
    Environment:
      Variables:
        AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
        APP_BASE_URL: https://tappy.cl
        API_BASE_URL: https://u1yadifvmj.execute-api.us-east-1.amazonaws.com/Prod
        TBK_USE_INTEGRATION: '1'
        KHIPU_API_KEY:
          Ref: KhipuApiKey
        PUBLIC_SUCCESS_URL:
          Ref: PublicSuccessUrl
        PUBLIC_CANCEL_URL:
          Ref: PublicCancelUrl
        PUBLIC_BASE_API:
          Ref: PublicBaseApi
        JWT_SECRET:
          Ref: JwtSecret
        DEPLOY_TAG:
          Ref: DeployTag
Resources:
  TappyApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: tappy-api-v3
      CodeUri: TappyApiFunction
      Handler: lambda.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName: Tappy_Users
      - DynamoDBCrudPolicy:
          TableName: Tappy_Orders
      - DynamoDBCrudPolicy:
          TableName: Tappy_Payments
      Events:
        ApiProxy:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY
    Metadata:
      SamResourceId: TappyApiFunction
Outputs:
  ApiUrl:
    Description: Invoke URL for Prod stage
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod
