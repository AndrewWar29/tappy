name: Setup CloudFront Infrastructure

on:
  workflow_dispatch:
    inputs:
      certificate_arn:
        description: 'ARN del certificado ACM (us-east-1)'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  STACK_NAME: tappy-profile-frontend
  ROLE_ARN: arn:aws:iam::837563945297:role/TappyDeployOIDC

permissions:
  id-token: write
  contents: read

jobs:
  create-infrastructure:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-InfraSetup

      - name: Check if stack exists
        id: check-stack
        continue-on-error: true
        run: |
          aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].StackStatus' \
            --output text

      - name: Create CloudFront Stack
        if: steps.check-stack.outcome == 'failure'
        run: |
          echo "Creating new CloudFront + S3 stack..."
          aws cloudformation create-stack \
            --stack-name ${{ env.STACK_NAME }} \
            --template-body file://client/cloudfront-template.yaml \
            --parameters \
              ParameterKey=DomainName,ParameterValue=profile.tappy.cl \
              ParameterKey=CertificateArn,ParameterValue=${{ github.event.inputs.certificate_arn }} \
            --region ${{ env.AWS_REGION }} \
            --capabilities CAPABILITY_IAM
          
          echo "Waiting for stack creation to complete..."
          aws cloudformation wait stack-create-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Update CloudFront Stack
        if: steps.check-stack.outcome == 'success'
        continue-on-error: true
        run: |
          echo "Stack exists, attempting update..."
          aws cloudformation update-stack \
            --stack-name ${{ env.STACK_NAME }} \
            --template-body file://client/cloudfront-template.yaml \
            --parameters \
              ParameterKey=DomainName,ParameterValue=profile.tappy.cl \
              ParameterKey=CertificateArn,ParameterValue=${{ github.event.inputs.certificate_arn }} \
            --region ${{ env.AWS_REGION }} \
            --capabilities CAPABILITY_IAM
          
          echo "Waiting for stack update to complete..."
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Get Stack Outputs
        id: outputs
        run: |
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`BucketName`].OutputValue' \
            --output text)
          
          DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`DistributionId`].OutputValue' \
            --output text)
          
          DISTRIBUTION_DOMAIN=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`DistributionDomainName`].OutputValue' \
            --output text)
          
          echo "bucket=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "distribution=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
          echo "domain=$DISTRIBUTION_DOMAIN" >> $GITHUB_OUTPUT

      - name: Infrastructure Summary
        run: |
          echo "âœ… CloudFront infrastructure ready!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Outputs" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: \`${{ steps.outputs.outputs.bucket }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront ID**: \`${{ steps.outputs.outputs.distribution }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **CloudFront Domain**: \`${{ steps.outputs.outputs.domain }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Configure DNS (Route 53 or external):" >> $GITHUB_STEP_SUMMARY
          echo "   - Type: CNAME" >> $GITHUB_STEP_SUMMARY
          echo "   - Name: profile.tappy.cl" >> $GITHUB_STEP_SUMMARY
          echo "   - Value: \`${{ steps.outputs.outputs.domain }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. Build and deploy frontend:" >> $GITHUB_STEP_SUMMARY
          echo "   - Push changes to \`client/\` to trigger automatic deploy" >> $GITHUB_STEP_SUMMARY
          echo "   - Or run: \`cd client && npm run build && ./deploy-frontend.sh\`" >> $GITHUB_STEP_SUMMARY
